

*실패 원자성(Failure Atomicity)**이란 메서드가 예외로 인해 실행을 멈추어도, 해당 객체는 메서드 호출 전 상태를 유지하는 것을 의미한다. 

작업 도중에 오류가 발생하더라도 객체의 무결성과 일관성이 보장되어야 한다. 
API 사용자의 입장에서 “메서드를 호출했는데 중간에 실패했다. 그렇다면 객체 상태는 어디까지 반영되었을까?”에 대한 불안함을 없애주기 때문이다.

## **메서드를 실패 원자적으로 만드는 방법**

1. **불변 객체로 설계**
	- 불변 객체는 상태가 변하지 않으므로, 예외가 발생해도 객체 상태가 손상되지 않는다.
2. **가변 객체의 경우, 작업 수행 전 매개변수 및 내부 상태의 유효성을 검사**
	- 내부 상태를 변경하기 전에, 예외가 발생할 수 있는 상황을 **메서드 초입부**에서 방지하자.
	- 예를 들어 스택에서 원소를 꺼낼 때, 스택이 비었으면 `EmptyStackException`을 던진다.
		- 만약 내부 구현상 인덱스 범위를 벗어났다고 `ArrayIndexOutOfBoundsException`을 던진다면, 사용자는 원인을 제대로 파악하기 어렵다.
	```java
	// 예시: 안전한 스택 pop
	public class SafeStack<T> {
		private final List<T> elements = new ArrayList<>();
	
		public T pop() {
			if (elements.isEmpty()) {
				throw new EmptyStackException();
			}
			// 실제 동작
			return elements.remove(elements.size() - 1);
		}
	}
	
	```
	
3. **객체의 임시 복사본에서 작업을 수행하고, 성공하면 원래 객체와 교체**
	- 예를 들어 정렬 작업 시, 리스트의 원소를 별도의 배열 복사본에 옮긴 뒤 정렬 작업 수행 → 성공 시 원본 리스트를 대체.
	- 작업 도중 오류가 나면, 원본 리스트는 변경되지 않은 상태로 남는다.
	```java
	// 예시: 임시 복사본을 이용한 정렬
	public void sortList(List<Integer> list) {
		// 임시 복사본
		Integer[] tempArray = list.toArray(new Integer[0]);
		try {
			Arrays.sort(tempArray); // 이 과정에서 실패할 수 있음
		} catch (Exception e) {
			// 실패 시 리스트는 변경되지 않음
			throw e;
		}
		// 성공 시에만 원본 업데이트
		for (int i = 0; i < list.size(); i++) {
			list.set(i, tempArray[i]);
		}
	}
	
	```
	
4. **작업 도중 발생하는 실패를 가로채는 복구 코드로 작업 전 상태로 되돌리기**
	- 주로 **디스크 기반** 자료구조 등 **내구성이 필요한** 상황에서 사용한다.
	- 예: 트랜잭션 기반 시스템에서 롤백(rollback) 처리.

## 실패 원자성을 달성하기 어렵거나 비용이 큰 경우
실패원자성은 권장되는 덕목이지만 항상 달성하긴 힘들다. 
- 두 스레드가 동기화 없이 동시에 수정한다면 일관성이 쉽게 깨지고, 여전히 쓸 수 있는 상태인지도 모르기 때문이다.
- `Error`(예: `OutOfMemoryError`) 같은 심각한 오류는 복구나 상태 롤백이 불가능할 수 있다.
- 비용이나 복잡도가 지나치게 크면 실패 원자성을 포기하는 경우도 있다.
	- 하지만 어디에서 실패하는지 디버깅이 가능하다면 시도해볼 만하다.

## API 명세와 객체 상태
- **메서드 명세에 기술한 예외**가 발생했을 때는, 객체 상태가 **메서드 호출 전과 동일**하도록 유지하는 것이 이상적이다.
- 만약 이를 지키지 못하면, API 문서에서 예외가 발생했을 때 객체가 어떤 상태가 되는지 명시해야 한다.

---

### **결론**

- 실패 원자성은 **강력한 안정성 보장**이지만, 모든 상황에서 달성하기 쉽지는 않다.
- **예외가 발생해도 객체를 안전하게 사용할 수 있도록** 설계하고,
- 가능한 한 **예외 발생 전 상태를 유지**하도록 노력하라.
- 이를 위해 **유효성 검사**, **임시 복사본**, **복구 코드** 등을 적절히 활용하자.